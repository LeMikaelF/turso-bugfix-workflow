%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#4f46e5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#818cf8', 'lineColor': '#94a3b8', 'secondaryColor': '#1e293b', 'tertiaryColor': '#0f172a', 'background': '#0f172a', 'mainBkg': '#1e293b', 'nodeBorder': '#4f46e5', 'clusterBkg': '#1e293b', 'titleColor': '#f8fafc', 'edgeLabelBackground': '#1e293b'}}}%%
flowchart TD
    subgraph PREFLIGHT["ğŸ›« Pre-flight Checks"]
        PF1["Verify Turso repo at latest main"]
        PF2["Build project"]
        PF3{"make test<br/>passes?"}
        PF3_ERR["Log error:<br/>baseline tests failed"]
        PF3_TERM(("âŒ Terminate"))
        PF4["Fetch unresolved panic<br/>+ SQL statements"]
    end

    subgraph REPO_SETUP["ğŸŒ¿ Repo Setup"]
        RS0["Create agentfs session:<br/>agentfs run --session panic-{id}"]
        RS1["Create branch:<br/>fix/panic-{id}"]
        RS2["Initialize context file:<br/>panic_context.md"]
        RS3["Create TCL test with<br/>failing SQL statements"]
        RS4["Launch Claude with MCP:<br/>agentfs serve mcp panic-{id}"]
        RS5{"make test-single<br/>fails with<br/>expected panic?"}
    end

    subgraph REPRODUCER["ğŸ”¬ Reproducer Agent<br/><i>â±ï¸ 60min timeout (excludes sim runtime)</i>"]
        R1["Load context from .md file"]
        R2["Analyze panic pattern<br/>& triggering conditions"]
        R3["Extend simulator to<br/>generate statements"]
        R4{"Simulator<br/>compiles?"}
        R5["Run simulator"]
        R6{"Panic<br/>reproduced?"}
        R7["ğŸ”§ describe-sim-fix:<br/>â€¢ record failing seed<br/>â€¢ why simulator missed it<br/>â€¢ what was added<br/>â€¢ update JSON block in .md file"]
        R8["ğŸ“Œ git commit (LLM):<br/>'reproducer: {panic_id}'"]
        RT{{"Timeout?"}}
    end

    subgraph FIXER["ğŸ”§ Fixer Agent<br/><i>â±ï¸ 60min timeout</i>"]
        F1["Load context from .md file"]
        F2["Analyze root cause"]
        F3["Implement fix"]
        F4{"Fix<br/>compiles?"}
        F4B["ğŸ“Œ git commit (LLM):<br/>'wip: fix compiles'"]
        F5["ğŸ”§ validate-fix (fast):<br/>â€¢ TCL test passes"]
        F6{"Fast gate<br/>passed?"}
        F7["ğŸ”§ validate-fix (slow):<br/>â€¢ make test passes<br/>â€¢ sim 10 runs pass"]
        F8{"Slow gate<br/>passed?"}
        F9["ğŸ”§ describe-fix:<br/>â€¢ bug description<br/>â€¢ fix description<br/>â€¢ update JSON block in .md file"]
        F10["ğŸ“Œ git commit (LLM):<br/>'fix: {panic_id}'"]
        FT{{"Timeout?"}}
    end

    subgraph SHIP["ğŸš€ Ship (Orchestrator)"]
        S1["Parse JSON block from .md file"]
        S2{"All required<br/>fields present?"}
        S3["Delete panic_context.md"]
        S4["Squash commits into single commit"]
        S5["open PR:<br/>â€¢ draft PR<br/>â€¢ tag reviewer"]
        S6["Update DB:<br/>status = 'pr_open'"]
        S7["Delete sandbox"]
        S8(("âœ¨ Done"))
    end

    subgraph ABORT["â›” Abort"]
        AB1["Mark panic as<br/>needs_human_review<br/>+ add context"]
        AB2["Log warning:<br/>sandbox retained for debugging"]
        AB3(("ğŸ›‘ Aborted"))
    end

%% Pre-flight flow
    PF1 --> PF2 --> PF3
    PF3 -->|No| PF3_ERR --> PF3_TERM
    PF3 -->|Yes| PF4
%% Repo setup flow
    PF4 --> RS0 --> RS1 --> RS2 --> RS3 --> RS4 --> RS5
    RS5 -->|No| AB1
    RS5 -->|Yes| R1
%% Reproducer agent flow
    R1 --> R2 --> R3 --> R4
    R4 -->|No| RT
    RT -->|No<br/>retry| R3
    RT -->|Yes| AB1
    R4 -->|Yes| R5 --> R6
    R6 -->|No| RT
    R6 -->|Yes| R7 --> R8
%% Fixer agent flow
    R8 --> F1 --> F2 --> F3 --> F4
    F4 -->|No| FT
    FT -->|No<br/>retry| F3
    FT -->|Yes| AB1
    F4 -->|Yes| F4B --> F5 --> F6
    F6 -->|No| F2
    F6 -->|Yes| F7 --> F8
    F8 -->|No| F2
    F8 -->|Yes| F9 --> F10
%% Ship flow (orchestrator)
    F10 --> S1 --> S2
    S2 -->|No| AB1
    S2 -->|Yes| S3 --> S4 --> S5 --> S6 --> S7 --> S8
%% Abort flow
    AB1 --> AB2 --> AB3
%% Next panic loop
    S8 -.->|" Next panic "| PF4
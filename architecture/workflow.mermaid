%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#4f46e5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#818cf8', 'lineColor': '#94a3b8', 'secondaryColor': '#1e293b', 'tertiaryColor': '#0f172a', 'background': '#0f172a', 'mainBkg': '#1e293b', 'nodeBorder': '#4f46e5', 'clusterBkg': '#1e293b', 'titleColor': '#f8fafc', 'edgeLabelBackground': '#1e293b'}}}%%
flowchart TD
    subgraph PREFLIGHT["ğŸ›« Pre-flight Checks"]
        PF1["Verify Turso repo at latest main"]
        PF2["Build project"]
        PF3{"make test<br/>passes?"}
        PF3_ERR["Log error:<br/>baseline tests failed"]
        PF3_TERM(("âŒ Terminate"))
        PF4["Fetch unresolved panic<br/>+ SQL statements"]
    end

    subgraph REPO_SETUP["ğŸŒ¿ Repo Setup"]
        RS0["Create agentfs session:<br/>agentfs run --session panic-{id}"]
        RS1["Create branch:<br/>fix/panic-{id}"]
        RS2["Initialize context files:<br/>panic_context.md + .json"]
        RS3["Create TCL test with<br/>failing SQL statements"]
        RS4["Launch Claude with MCP:<br/>agentfs serve mcp panic-{id}"]
        RS5{"make test-single<br/>fails with<br/>expected panic?"}
    end

    subgraph REPRODUCER_PLANNER["ğŸ“‹ Reproducer Planner<br/><i>â±ï¸ 15min timeout</i>"]
        RP1["Load context from<br/>.md and .json files"]
        RP2["Analyze panic location<br/>in core/"]
        RP3["Analyze SQL patterns"]
        RP4["Study simulator in<br/>simulator/generation/"]
        RP5["ğŸ”§ write-reproducer-plan:<br/>â€¢ analysis summary<br/>â€¢ root cause hypothesis<br/>â€¢ files to modify<br/>â€¢ generation strategy"]
        RP6["Creates reproducer_plan.md"]
        RPT{{"Timeout?"}}
    end

    subgraph REPRODUCER_IMPL["ğŸ”¬ Reproducer Implementer<br/><i>â±ï¸ 45min timeout (excludes sim runtime)</i>"]
        RI1["Read reproducer_plan.md"]
        RI2["Implement changes from plan"]
        RI3{"Simulator<br/>compiles?"}
        RI4["Run simulator"]
        RI5{"Panic<br/>reproduced?"}
        RI6["ğŸ”§ describe-sim-fix:<br/>â€¢ failing_seed<br/>â€¢ why simulator missed it<br/>â€¢ what was added<br/>(updates panic_context.json)"]
        RI7["ğŸ“Œ git commit (Orchestrator):<br/>'reproducer: {panic_id}'"]
        RIT{{"Timeout?"}}
    end

    subgraph FIXER_PLANNER["ğŸ“‹ Fixer Planner<br/><i>â±ï¸ 15min timeout</i>"]
        FP1["Load context from<br/>.md, .json, and reproducer_plan.md"]
        FP2["Navigate to panic location"]
        FP3["Trace root cause"]
        FP4["Analyze SQL execution path"]
        FP5["ğŸ”§ write-fixer-plan:<br/>â€¢ root cause analysis<br/>â€¢ code path trace<br/>â€¢ fix strategy<br/>â€¢ risk assessment"]
        FP6["Creates fixer_plan.md"]
        FPT{{"Timeout?"}}
    end

    subgraph FIXER_IMPL["ğŸ”§ Fixer Implementer<br/><i>â±ï¸ 45min timeout</i>"]
        FI1["Read fixer_plan.md"]
        FI2["Implement fix from plan"]
        FI3{"Fix<br/>compiles?"}
        FI4["ğŸ”§ validate-fix:<br/>â€¢ TCL test passes<br/>â€¢ make test passes<br/>â€¢ sim 10 runs pass"]
        FI5{"Validation<br/>passed?"}
        FI6["ğŸ”§ describe-fix:<br/>â€¢ bug description<br/>â€¢ fix description<br/>(updates panic_context.json)"]
        FI7["ğŸ“Œ git commit (Orchestrator):<br/>â€¢ clippy --fix<br/>â€¢ cargo fmt<br/>'fix: {panic_id}'"]
        FIT{{"Timeout?"}}
    end

    subgraph SHIP["ğŸš€ Ship (Orchestrator)"]
        S1["Read panic_context.json"]
        S2{"All required<br/>fields present?"}
        S3["Delete context files<br/>(.md, .json, *_plan.md)"]
        S4["Squash commits into single commit"]
        S5["open PR:<br/>â€¢ draft PR<br/>â€¢ tag reviewer"]
        S6["Update DB:<br/>status = 'pr_open'"]
        S7["Delete sandbox"]
        S8(("âœ¨ Done"))
    end

    subgraph ABORT["â›” Abort"]
        AB1["Mark panic as<br/>needs_human_review<br/>+ add context"]
        AB2["Log warning:<br/>sandbox retained for debugging"]
        AB3(("ğŸ›‘ Aborted"))
    end

%% Pre-flight flow
    PF1 --> PF2 --> PF3
    PF3 -->|No| PF3_ERR --> PF3_TERM
    PF3 -->|Yes| PF4
%% Repo setup flow
    PF4 --> RS0 --> RS1 --> RS2 --> RS3 --> RS4 --> RS5
    RS5 -->|No| AB1
    RS5 -->|Yes| RP1
%% Reproducer Planner flow
    RP1 --> RP2 --> RP3 --> RP4 --> RP5 --> RP6
    RP2 --> RPT
    RPT -->|Yes| AB1
    RPT -->|No| RP3
    RP6 --> RI1
%% Reproducer Implementer flow
    RI1 --> RI2 --> RI3
    RI3 -->|No| RIT
    RIT -->|No<br/>retry| RI2
    RIT -->|Yes| AB1
    RI3 -->|Yes| RI4 --> RI5
    RI5 -->|No| RIT
    RI5 -->|Yes| RI6 --> RI7
%% Fixer Planner flow
    RI7 --> FP1 --> FP2 --> FP3 --> FP4 --> FP5 --> FP6
    FP2 --> FPT
    FPT -->|Yes| AB1
    FPT -->|No| FP3
    FP6 --> FI1
%% Fixer Implementer flow
    FI1 --> FI2 --> FI3
    FI3 -->|No| FIT
    FIT -->|No<br/>retry| FI2
    FIT -->|Yes| AB1
    FI3 -->|Yes| FI4 --> FI5
    FI5 -->|No| FI2
    FI5 -->|Yes| FI6 --> FI7
%% Ship flow (orchestrator)
    FI7 --> S1 --> S2
    S2 -->|No| AB1
    S2 -->|Yes| S3 --> S4 --> S5 --> S6 --> S7 --> S8
%% Abort flow
    AB1 --> AB2 --> AB3
%% Next panic loop
    S8 -.->|" Next panic "| PF4
